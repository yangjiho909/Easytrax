name: Deploy to AWS Elastic Beanstalk

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-2
  EB_APPLICATION_NAME: kati-export-helper
  EB_ENVIRONMENT_NAME: kati-production

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Create deployment package
      run: |
        # í•„ìš”í•œ ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p advanced_labels generated_documents uploaded_labels uploaded_templates temp_uploads regulation_cache static
        
        # ë°°í¬ìš© ZIP íŒŒì¼ ìƒì„±
        zip -r deployment.zip . -x "*.git*" "*.pyc" "__pycache__/*" "*.DS_Store" "node_modules/*" ".env*"
        
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: Deploy to Elastic Beanstalk
      run: |
        # EB CLI ì„¤ì¹˜
        pip install awsebcli
        
        # EB ì´ˆê¸°í™” (ì´ë¯¸ ì„¤ì •ë˜ì–´ ìˆë‹¤ë©´ ê±´ë„ˆëœ€)
        eb init ${{ env.EB_APPLICATION_NAME }} --region ${{ env.AWS_REGION }} --platform "Python 3.11" || true
        
        # í™˜ê²½ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ê³  ë°°í¬
        if eb status ${{ env.EB_ENVIRONMENT_NAME }} --region ${{ env.AWS_REGION }}; then
          # ê¸°ì¡´ í™˜ê²½ì— ë°°í¬
          eb deploy ${{ env.EB_ENVIRONMENT_NAME }} --region ${{ env.AWS_REGION }}
        else
          # ìƒˆ í™˜ê²½ ìƒì„±
          eb create ${{ env.EB_ENVIRONMENT_NAME }} --region ${{ env.AWS_REGION }} --instance-type t3.small --elb-type application
        fi
        
    - name: Get deployment URL
      run: |
        pip install awsebcli
        DEPLOYMENT_URL=$(eb status ${{ env.EB_ENVIRONMENT_NAME }} --region ${{ env.AWS_REGION }} --output json | jq -r '.CNAME')
        echo "Deployment URL: http://$DEPLOYMENT_URL"
        echo "DEPLOYMENT_URL=http://$DEPLOYMENT_URL" >> $GITHUB_ENV
        
    - name: Notify deployment success
      if: success()
      run: |
        echo "âœ… ë°°í¬ ì„±ê³µ!"
        echo "ğŸŒ ë°°í¬ URL: ${{ env.DEPLOYMENT_URL }}"
        
    - name: Notify deployment failure
      if: failure()
      run: |
        echo "âŒ ë°°í¬ ì‹¤íŒ¨!"
        echo "ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”." 